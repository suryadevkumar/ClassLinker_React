-- Table: INSTITUTE
CREATE TABLE INSTITUTE (
    INS_ID       NUMBER PRIMARY KEY,
    INS_NAME     VARCHAR2(70) NOT NULL,
    INS_CODE     NUMBER NOT NULL,
    INS_ADDRESS  VARCHAR2(100) NOT NULL,
    INS_EMAIL    VARCHAR2(40) NOT NULL,
    INS_MOBILE   VARCHAR2(15) NOT NULL,
    INS_PASS     VARCHAR2(100) NOT NULL,
    AD_NAME      VARCHAR2(30) NOT NULL,
    AD_MOBILE    VARCHAR2(15) NOT NULL,
    AD_EMAIL     VARCHAR2(30) NOT NULL,
    AD_PIC       BLOB,
    CONSTRAINT UK_INS_EMAIL UNIQUE (INS_EMAIL),
    CONSTRAINT UK_INS_CODE UNIQUE (INS_CODE),
    CONSTRAINT UK_INS_MOBILE UNIQUE (INS_MOBILE)
);

-- Table: DEPARTMENT
CREATE TABLE DEPARTMENT (
    DEP_ID     NUMBER PRIMARY KEY,
    DEP_NAME   VARCHAR2(50) NOT NULL
);

-- Table: COURSE
CREATE TABLE COURSE (
    CRS_ID     NUMBER PRIMARY KEY,
    CRS_NAME   VARCHAR2(50) NOT NULL
);

-- Table: CLASS
CREATE TABLE CLASS (
    CLS_ID     NUMBER PRIMARY KEY,
    CLS_NAME   VARCHAR2(20) NOT NULL,
    SECTION    NUMBER NOT NULL
);

-- Table: TEACHER
CREATE TABLE TEACHER (
    TCH_ID      NUMBER PRIMARY KEY,
    TCH_NAME    VARCHAR2(30) NOT NULL,
    TCH_MOBILE  VARCHAR2(15) NOT NULL,
    TCH_EMAIL   VARCHAR2(40) NOT NULL,
    TCH_PASS    VARCHAR2(100) NOT NULL,
    TCH_PIC     BLOB,
    TCH_CODE    NUMBER NOT NULL,
    VERIFIED    VARCHAR2(10) DEFAULT 'Unverified',
    INS_ID      NUMBER NOT NULL,
    CONSTRAINT FK_TCH_INS FOREIGN KEY (INS_ID) REFERENCES INSTITUTE(INS_ID),
    CONSTRAINT UK_TCH_EMAIL UNIQUE (TCH_EMAIL),
    CONSTRAINT UK_TCH_MOBILE UNIQUE (TCH_MOBILE),
    CONSTRAINT UK_TCH_CODE UNIQUE (TCH_CODE)
);

-- Table: IDCC (Institute-Department-Course-Class)
CREATE TABLE IDCC (
    IDCC_ID     NUMBER PRIMARY KEY,
    INS_ID      NUMBER NOT NULL,
    DEP_ID      NUMBER NOT NULL,
    CRS_ID      NUMBER NOT NULL,
    CLS_ID      NUMBER NOT NULL,
    CONSTRAINT FK_IDCC_INS FOREIGN KEY (INS_ID) REFERENCES INSTITUTE(INS_ID),
    CONSTRAINT FK_IDCC_DEP FOREIGN KEY (DEP_ID) REFERENCES DEPARTMENT(DEP_ID),
    CONSTRAINT FK_IDCC_CRS FOREIGN KEY (CRS_ID) REFERENCES COURSE(CRS_ID),
    CONSTRAINT FK_IDCC_CLS FOREIGN KEY (CLS_ID) REFERENCES CLASS(CLS_ID),
    CONSTRAINT UK_IDCC_COMBINATION UNIQUE (INS_ID, DEP_ID, CRS_ID, CLS_ID)
);

-- Table: SUBJECT
CREATE TABLE SUBJECT (
    SUB_ID      NUMBER PRIMARY KEY,
    SUB_NAME    VARCHAR2(30) NOT NULL,
    IDCC_ID     NUMBER NOT NULL,
    TCH_ID      NUMBER,
    CONSTRAINT FK_SUB_TCH FOREIGN KEY (TCH_ID) REFERENCES TEACHER(TCH_ID),
    CONSTRAINT FK_SUB_IDCC FOREIGN KEY (IDCC_ID) REFERENCES IDCC(IDCC_ID),
    CONSTRAINT UK_SUB_COMBINATION UNIQUE (SUB_NAME, IDCC_ID)
);

-- Table: STUDENT
CREATE TABLE STUDENT (
    STD_ID      NUMBER PRIMARY KEY,
    STD_NAME    VARCHAR2(30) NOT NULL,
    STD_DOB     DATE NOT NULL,
    STD_MOBILE  VARCHAR2(15) NOT NULL,
    STD_EMAIL   VARCHAR2(40) NOT NULL,
    STD_PASS    VARCHAR2(100) NOT NULL,
    STD_PIC     BLOB,
    STD_DOC     BLOB,
    SCH_ID      NUMBER,
    VERIFIED    VARCHAR2(10) DEFAULT 'Unverified',
    IDCC_ID     NUMBER NOT NULL,
    SECTION     NUMBER NOT NULL,
    CONSTRAINT FK_STD_IDCC FOREIGN KEY (IDCC_ID) REFERENCES IDCC(IDCC_ID),
    CONSTRAINT UK_STD_EMAIL UNIQUE (STD_EMAIL),
    CONSTRAINT UK_STD_MOBILE UNIQUE (STD_MOBILE)
);

-- Table: NOTES
CREATE TABLE NOTES (
    NOTES_ID     NUMBER PRIMARY KEY,
    NOTES_NAME   VARCHAR2(30) NOT NULL,
    SUB_ID       NUMBER NOT NULL,
    NOTES_FILE   BLOB NOT NULL,
    FILE_TYPE    VARCHAR2(100) NOT NULL,
    UPLOAD_DATE  DATE DEFAULT SYSDATE,
    CONSTRAINT FK_NOTES_SUB FOREIGN KEY (SUB_ID) REFERENCES SUBJECT(SUB_ID)
);

-- Table: ASSIGNMENT
CREATE TABLE ASSIGNMENT (
    AS_ID        NUMBER PRIMARY KEY,
    AS_NAME      VARCHAR2(30) NOT NULL,
    SUB_ID       NUMBER NOT NULL,
    AS_FILE      BLOB NOT NULL,
    FILE_TYPE    VARCHAR2(100) NOT NULL,
    DUE_DATE     DATE NOT NULL,
    UPLOAD_DATE  DATE DEFAULT SYSDATE,
    CONSTRAINT FK_AS_SUB FOREIGN KEY (SUB_ID) REFERENCES SUBJECT(SUB_ID)
);

-- Table: ATTENDANCE
CREATE TABLE ATTENDANCE (
    ATTEND_ID      NUMBER PRIMARY KEY,
    ATTEND_DATE    DATE DEFAULT SYSDATE,
    ATTEND_STATUS  VARCHAR2(10) NOT NULL,
    STD_ID         NUMBER NOT NULL,
    SUB_ID         NUMBER NOT NULL,
    CONSTRAINT FK_ATTEND_STD FOREIGN KEY (STD_ID) REFERENCES STUDENT(STD_ID),
    CONSTRAINT FK_ATTEND_SUB FOREIGN KEY (SUB_ID) REFERENCES SUBJECT(SUB_ID),
    CONSTRAINT UK_ATTEND_RECORD UNIQUE (ATTEND_DATE, STD_ID, SUB_ID)
);

-- Table: CHAT
CREATE TABLE CHAT (
    CHAT_ID     NUMBER PRIMARY KEY,
    USER_ID     NUMBER NOT NULL,
    SUB_ID      NUMBER NOT NULL,
    MESSAGE     VARCHAR2(2000) NOT NULL,
    TIME        TIMESTAMP DEFAULT SYSTIMESTAMP,
    USER_NAME   VARCHAR2(100) NOT NULL,
    USER_TYPE   VARCHAR2(10) NOT NULL,
    CONSTRAINT FK_CHAT_SUB FOREIGN KEY (SUB_ID) REFERENCES SUBJECT(SUB_ID)
);

-- Table: STD_ASSIGNMENT_SUBMIT
CREATE TABLE STD_ASSIGNMENT_SUBMIT (
    SUBMIT_ID        NUMBER PRIMARY KEY,
    STD_ID           NUMBER NOT NULL,
    AS_ID            NUMBER NOT NULL,
    SUBMIT_DATE      DATE DEFAULT SYSDATE,
    PDF_FILE         BLOB NOT NULL,
    FILE_TYPE        VARCHAR2(20) NOT NULL,
    GRADE            NUMBER,
    FEEDBACK         VARCHAR2(500),
    CONSTRAINT FK_SUBMIT_STD FOREIGN KEY (STD_ID) REFERENCES STUDENT(STD_ID),
    CONSTRAINT FK_SUBMIT_AS FOREIGN KEY (AS_ID) REFERENCES ASSIGNMENT(AS_ID),
    CONSTRAINT UK_STD_ASSIGNMENT UNIQUE (STD_ID, AS_ID)
);

-- Table: SUBJECT_VIDEO
CREATE TABLE SUBJECT_VIDEO (
    VIDEO_ID      NUMBER PRIMARY KEY,
    SUB_ID        NUMBER NOT NULL,
    VIDEO_TITLE   VARCHAR2(100) NOT NULL,
    VIDEO_FILE    BLOB NOT NULL,
    FILE_TYPE     VARCHAR2(20) NOT NULL,
    FILE_SIZE     NUMBER,
    UPLOAD_DATE   DATE DEFAULT SYSDATE,
    DESCRIPTION   VARCHAR2(500),
    CONSTRAINT FK_VIDEO_SUB FOREIGN KEY (SUB_ID) REFERENCES SUBJECT(SUB_ID)
);

--------------------------------------------------------------------------------------------------------
-- VIEWS
--------------------------------------------------------------------------------------------------------

-- View: CLASS_VIEW
CREATE OR REPLACE VIEW CLASS_VIEW AS
SELECT DISTINCT 
    INST.INS_ID, INST.INS_NAME,
    ID.IDCC_ID, DP.DEP_ID, 
    DP.DEP_NAME, CR.CRS_ID, 
    CR.CRS_NAME, CL.CLS_ID, 
    CL.CLS_NAME, CL.SECTION
FROM IDCC ID 
JOIN INSTITUTE INST ON INST.INS_ID = ID.INS_ID 
JOIN COURSE CR ON CR.CRS_ID = ID.CRS_ID 
JOIN DEPARTMENT DP ON DP.DEP_ID = ID.DEP_ID
JOIN CLASS CL ON CL.CLS_ID = ID.CLS_ID;

-- View: STUDENT_VIEW
CREATE OR REPLACE VIEW STUDENT_VIEW AS
SELECT DISTINCT 
    ST.STD_ID, ST.STD_NAME, ST.STD_DOB, ST.STD_MOBILE, 
    ST.STD_EMAIL, ST.STD_PIC, ST.STD_DOC, ST.VERIFIED, 
    ST.SCH_ID, ST.SECTION, INS.INS_ID, INS.INS_NAME, 
    ID.IDCC_ID, DP.DEP_ID, DP.DEP_NAME, CRS.CRS_ID, 
    CRS.CRS_NAME, CLS.CLS_ID, CLS.CLS_NAME
FROM STUDENT ST 
JOIN IDCC ID ON ST.IDCC_ID=ID.IDCC_ID 
JOIN INSTITUTE INS ON INS.INS_ID=ID.INS_ID 
JOIN DEPARTMENT DP ON DP.DEP_ID=ID.DEP_ID 
JOIN COURSE CRS ON CRS.CRS_ID=ID.CRS_ID 
JOIN CLASS CLS ON CLS.CLS_ID=ID.CLS_ID;

-- View: SUBJECT_VIEW
CREATE OR REPLACE VIEW SUBJECT_VIEW AS
SELECT DISTINCT 
    INST.INS_ID, INST.INS_NAME,
    ID.IDCC_ID, DP.DEP_ID, 
    DP.DEP_NAME, CR.CRS_ID, 
    CR.CRS_NAME, CL.CLS_ID, 
    CL.CLS_NAME, CL.SECTION, 
    SUB.SUB_ID, SUB.SUB_NAME,
    TCH.TCH_ID, TCH.TCH_NAME
FROM IDCC ID 
JOIN INSTITUTE INST ON INST.INS_ID = ID.INS_ID 
JOIN COURSE CR ON CR.CRS_ID = ID.CRS_ID 
JOIN DEPARTMENT DP ON DP.DEP_ID = ID.DEP_ID
JOIN CLASS CL ON CL.CLS_ID = ID.CLS_ID
JOIN SUBJECT SUB ON SUB.IDCC_ID=ID.IDCC_ID 
LEFT JOIN TEACHER TCH ON TCH.TCH_ID=SUB.TCH_ID;

--------------------------------------------------------------------------------------------------------
-- SEQUENCES
--------------------------------------------------------------------------------------------------------

-- Sequence for TEACHER primary key (TCH_ID)
CREATE SEQUENCE TCH_ID_SEQ 
START WITH 10000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for SUBJECT primary key (SUB_ID)
CREATE SEQUENCE SUB_ID_SEQ 
START WITH 20000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for INSTITUTE primary key (INS_ID)
CREATE SEQUENCE INS_ID_SEQ 
START WITH 30000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for DEPARTMENT primary key (DEP_ID)
CREATE SEQUENCE DEP_ID_SEQ 
START WITH 40000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for COURSE primary key (CRS_ID)
CREATE SEQUENCE CRS_ID_SEQ 
START WITH 50000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for CLASS primary key (CLS_ID)
CREATE SEQUENCE CLS_ID_SEQ 
START WITH 60000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for STUDENT primary key (STD_ID)
CREATE SEQUENCE STD_ID_SEQ 
START WITH 70000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for IDCC primary key (IDCC_ID)
CREATE SEQUENCE IDCC_ID_SEQ 
START WITH 80000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for NOTES primary key (NOTES_ID)
CREATE SEQUENCE NOTES_ID_SEQ 
START WITH 90000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for ASSIGNMENT primary key (AS_ID)
CREATE SEQUENCE ASSIGNMENT_ID_SEQ 
START WITH 100000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for ATTENDANCE primary key (ATTEND_ID)
CREATE SEQUENCE ATTEND_ID_SEQ 
START WITH 110000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for CHAT primary key (CHAT_ID)
CREATE SEQUENCE CHAT_ID_SEQ 
START WITH 120000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for VIDEO primary key (VIDEO_ID)
CREATE SEQUENCE VIDEO_ID_SEQ 
START WITH 130000001
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Sequence for SUBMISSION primary key (SUBMIT_ID)
CREATE SEQUENCE SUBMIT_ID_SEQ 
START WITH 140000001
INCREMENT BY 1
NOCACHE
NOCYCLE;



--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------

--FOR DELETION

-- Drop Views
DROP VIEW CLASS_VIEW;
DROP VIEW SUBJECT_VIEW;

-- Drop Tables
DROP TABLE SUBJECT_VIDEO CASCADE CONSTRAINTS;
DROP TABLE STD_ASSIGNMENT_SUBMIT CASCADE CONSTRAINTS;
DROP TABLE CHAT CASCADE CONSTRAINTS;
DROP TABLE ATTENDANCE CASCADE CONSTRAINTS;
DROP TABLE ASSIGNMENT CASCADE CONSTRAINTS;
DROP TABLE NOTES CASCADE CONSTRAINTS;
DROP TABLE STUDENT CASCADE CONSTRAINTS;
DROP TABLE SUBJECT CASCADE CONSTRAINTS;
DROP TABLE IDCC CASCADE CONSTRAINTS;
DROP TABLE TEACHER CASCADE CONSTRAINTS;
DROP TABLE CLASS CASCADE CONSTRAINTS;
DROP TABLE COURSE CASCADE CONSTRAINTS;
DROP TABLE DEPARTMENT CASCADE CONSTRAINTS;
DROP TABLE INSTITUTE CASCADE CONSTRAINTS;

-- Drop Sequences
DROP SEQUENCE TCH_ID_SEQ;
DROP SEQUENCE SUB_ID_SEQ;
DROP SEQUENCE INS_ID_SEQ;
DROP SEQUENCE DEP_ID_SEQ;
DROP SEQUENCE CRS_ID_SEQ;
DROP SEQUENCE CLS_ID_SEQ;
DROP SEQUENCE IDCC_ID_SEQ;
DROP SEQUENCE STD_ID_SEQ;
DROP SEQUENCE NOTES_ID_SEQ;
DROP SEQUENCE ASSIGNMENT_ID_SEQ;
DROP SEQUENCE ATTEND_ID_SEQ;
DROP SEQUENCE CHAT_ID_SEQ;
DROP SEQUENCE SUBMIT_ID_SEQ;
DROP SEQUENCE VIDEO_ID_SEQ;
